{
  "openapi": "3.0.0",
  "info": {
    "title": "Sandbox Task API",
    "description": "API for managing tasks in sandbox",
    "version": "1.0.0"
  },
  "paths": {
    "/task/list": {
      "post": {
        "summary": "List tasks",
        "description": "Retrieve a list of all configured tasks",
        "operationId": "taskList",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {}
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Successful operation",
            "content": {
              "application/json": {
                "schema": {
                  "allOf": [
                    {
                      "$ref": "#/components/schemas/SuccessResponse"
                    },
                    {
                      "type": "object",
                      "properties": {
                        "result": {
                          "$ref": "#/components/schemas/TaskListDTO"
                        }
                      }
                    }
                  ]
                }
              }
            }
          },
          "400": {
            "description": "Error retrieving task list",
            "content": {
              "application/json": {
                "schema": {
                  "allOf": [
                    {
                      "$ref": "#/components/schemas/ErrorResponse"
                    },
                    {
                      "type": "object",
                      "properties": {
                        "error": {
                          "$ref": "#/components/schemas/CommonError"
                        }
                      }
                    }
                  ]
                }
              }
            }
          }
        }
      }
    },
    "/task/run": {
      "post": {
        "summary": "Run task",
        "description": "Start execution of a task by ID",
        "operationId": "taskRun",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "taskId": {
                    "type": "string",
                    "description": "ID of the task to run"
                  }
                },
                "required": ["taskId"]
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Successful operation",
            "content": {
              "application/json": {
                "schema": {
                  "allOf": [
                    {
                      "$ref": "#/components/schemas/SuccessResponse"
                    },
                    {
                      "type": "object",
                      "properties": {
                        "result": {
                          "$ref": "#/components/schemas/TaskDTO"
                        }
                      }
                    }
                  ]
                }
              }
            }
          },
          "400": {
            "description": "Error running task",
            "content": {
              "application/json": {
                "schema": {
                  "allOf": [
                    {
                      "$ref": "#/components/schemas/ErrorResponse"
                    },
                    {
                      "type": "object",
                      "properties": {
                        "error": {
                          "$ref": "#/components/schemas/TaskError"
                        }
                      }
                    }
                  ]
                }
              }
            }
          }
        }
      }
    },
    "/task/runCommand": {
      "post": {
        "summary": "Run command",
        "description": "Run a shell command directly, optionally saving it as a task",
        "operationId": "taskRunCommand",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "command": {
                    "type": "string",
                    "description": "Command to run"
                  },
                  "name": {
                    "type": "string",
                    "description": "Optional name for the task",
                    "nullable": true
                  },
                  "saveToConfig": {
                    "type": "boolean",
                    "description": "Whether to save this command as a task in the config",
                    "nullable": true
                  }
                },
                "required": ["command"]
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Successful operation",
            "content": {
              "application/json": {
                "schema": {
                  "allOf": [
                    {
                      "$ref": "#/components/schemas/SuccessResponse"
                    },
                    {
                      "type": "object",
                      "properties": {
                        "result": {
                          "$ref": "#/components/schemas/TaskDTO"
                        }
                      }
                    }
                  ]
                }
              }
            }
          },
          "400": {
            "description": "Error running command",
            "content": {
              "application/json": {
                "schema": {
                  "allOf": [
                    {
                      "$ref": "#/components/schemas/ErrorResponse"
                    },
                    {
                      "type": "object",
                      "properties": {
                        "error": {
                          "$ref": "#/components/schemas/TaskError"
                        }
                      }
                    }
                  ]
                }
              }
            }
          }
        }
      }
    },
    "/task/stop": {
      "post": {
        "summary": "Stop task",
        "description": "Stop execution of a running task",
        "operationId": "taskStop",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "taskId": {
                    "type": "string",
                    "description": "ID of the task to stop"
                  }
                },
                "required": ["taskId"]
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Successful operation",
            "content": {
              "application/json": {
                "schema": {
                  "allOf": [
                    {
                      "$ref": "#/components/schemas/SuccessResponse"
                    },
                    {
                      "type": "object",
                      "properties": {
                        "result": {
                          "oneOf": [
                            {
                              "$ref": "#/components/schemas/TaskDTO"
                            },
                            {
                              "type": "null",
                              "description": "Null when stopping an unconfigured task"
                            }
                          ]
                        }
                      }
                    }
                  ]
                }
              }
            }
          },
          "400": {
            "description": "Error stopping task",
            "content": {
              "application/json": {
                "schema": {
                  "allOf": [
                    {
                      "$ref": "#/components/schemas/ErrorResponse"
                    },
                    {
                      "type": "object",
                      "properties": {
                        "error": {
                          "$ref": "#/components/schemas/TaskError"
                        }
                      }
                    }
                  ]
                }
              }
            }
          }
        }
      }
    },
    "/task/create": {
      "post": {
        "summary": "Create task",
        "description": "Create a new task configuration",
        "operationId": "taskCreate",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "taskFields": {
                    "$ref": "#/components/schemas/TaskDefinitionDTO"
                  },
                  "startTask": {
                    "type": "boolean",
                    "description": "Whether to start the task immediately after creation",
                    "nullable": true
                  }
                },
                "required": ["taskFields"]
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Successful operation",
            "content": {
              "application/json": {
                "schema": {
                  "allOf": [
                    {
                      "$ref": "#/components/schemas/SuccessResponse"
                    },
                    {
                      "type": "object",
                      "properties": {
                        "result": {
                          "$ref": "#/components/schemas/TaskListDTO"
                        }
                      }
                    }
                  ]
                }
              }
            }
          },
          "400": {
            "description": "Error creating task",
            "content": {
              "application/json": {
                "schema": {
                  "allOf": [
                    {
                      "$ref": "#/components/schemas/ErrorResponse"
                    },
                    {
                      "type": "object",
                      "properties": {
                        "error": {
                          "$ref": "#/components/schemas/TaskError"
                        }
                      }
                    }
                  ]
                }
              }
            }
          }
        }
      }
    },
    "/task/update": {
      "post": {
        "summary": "Update task",
        "description": "Update an existing task configuration",
        "operationId": "taskUpdate",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "taskId": {
                    "type": "string",
                    "description": "ID of the task to update"
                  },
                  "taskFields": {
                    "type": "object",
                    "description": "Fields to update in the task",
                    "properties": {
                      "name": {
                        "type": "string",
                        "description": "Name of the task",
                        "nullable": true
                      },
                      "command": {
                        "type": "string",
                        "description": "Command to run",
                        "nullable": true
                      },
                      "runAtStart": {
                        "type": "boolean",
                        "description": "Whether to run the task at sandbox start",
                        "nullable": true
                      },
                      "preview": {
                        "type": "object",
                        "properties": {
                          "port": {
                            "type": "number",
                            "description": "Port to use for previewing the task",
                            "nullable": true
                          },
                          "pr-link": {
                            "type": "string",
                            "enum": ["direct", "redirect", "devtool"],
                            "description": "Type of PR link to use",
                            "nullable": true
                          }
                        },
                        "nullable": true
                      }
                    }
                  }
                },
                "required": ["taskId", "taskFields"]
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Successful operation",
            "content": {
              "application/json": {
                "schema": {
                  "allOf": [
                    {
                      "$ref": "#/components/schemas/SuccessResponse"
                    },
                    {
                      "type": "object",
                      "properties": {
                        "result": {
                          "$ref": "#/components/schemas/TaskDTO"
                        }
                      }
                    }
                  ]
                }
              }
            }
          },
          "400": {
            "description": "Error updating task",
            "content": {
              "application/json": {
                "schema": {
                  "allOf": [
                    {
                      "$ref": "#/components/schemas/ErrorResponse"
                    },
                    {
                      "type": "object",
                      "properties": {
                        "error": {
                          "$ref": "#/components/schemas/TaskError"
                        }
                      }
                    }
                  ]
                }
              }
            }
          }
        }
      }
    },
    "/task/saveToConfig": {
      "post": {
        "summary": "Save task to config",
        "description": "Save a runtime task to the configuration file",
        "operationId": "taskSaveToConfig",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "taskId": {
                    "type": "string",
                    "description": "ID of the task to save to config"
                  }
                },
                "required": ["taskId"]
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Successful operation",
            "content": {
              "application/json": {
                "schema": {
                  "allOf": [
                    {
                      "$ref": "#/components/schemas/SuccessResponse"
                    },
                    {
                      "type": "object",
                      "properties": {
                        "result": {
                          "$ref": "#/components/schemas/TaskDTO"
                        }
                      }
                    }
                  ]
                }
              }
            }
          },
          "400": {
            "description": "Error saving task to config",
            "content": {
              "application/json": {
                "schema": {
                  "allOf": [
                    {
                      "$ref": "#/components/schemas/ErrorResponse"
                    },
                    {
                      "type": "object",
                      "properties": {
                        "error": {
                          "$ref": "#/components/schemas/TaskError"
                        }
                      }
                    }
                  ]
                }
              }
            }
          }
        }
      }
    },
    "/task/generateConfig": {
      "post": {
        "summary": "Generate task config",
        "description": "Generate a configuration file from current tasks",
        "operationId": "taskGenerateConfig",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {}
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Successful operation",
            "content": {
              "application/json": {
                "schema": {
                  "allOf": [
                    {
                      "$ref": "#/components/schemas/SuccessResponse"
                    },
                    {
                      "type": "object",
                      "properties": {
                        "result": {
                          "type": "null"
                        }
                      }
                    }
                  ]
                }
              }
            }
          },
          "400": {
            "description": "Error generating config",
            "content": {
              "application/json": {
                "schema": {
                  "allOf": [
                    {
                      "$ref": "#/components/schemas/ErrorResponse"
                    },
                    {
                      "type": "object",
                      "properties": {
                        "error": {
                          "$ref": "#/components/schemas/TaskError"
                        }
                      }
                    }
                  ]
                }
              }
            }
          }
        }
      }
    },
    "/task/createSetupTasks": {
      "post": {
        "summary": "Create setup tasks",
        "description": "Create tasks that run during sandbox setup",
        "operationId": "taskCreateSetupTasks",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "tasks": {
                    "type": "array",
                    "items": {
                      "$ref": "#/components/schemas/TaskDefinitionDTO"
                    },
                    "description": "Setup tasks to create"
                  }
                },
                "required": ["tasks"]
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Successful operation",
            "content": {
              "application/json": {
                "schema": {
                  "allOf": [
                    {
                      "$ref": "#/components/schemas/SuccessResponse"
                    },
                    {
                      "type": "object",
                      "properties": {
                        "result": {
                          "type": "null"
                        }
                      }
                    }
                  ]
                }
              }
            }
          },
          "400": {
            "description": "Error creating setup tasks",
            "content": {
              "application/json": {
                "schema": {
                  "allOf": [
                    {
                      "$ref": "#/components/schemas/ErrorResponse"
                    },
                    {
                      "type": "object",
                      "properties": {
                        "error": {
                          "$ref": "#/components/schemas/TaskError"
                        }
                      }
                    }
                  ]
                }
              }
            }
          }
        }
      }
    }
  },
  "components": {
    "schemas": {
      "SuccessResponse": {
        "type": "object",
        "properties": {
          "status": {
            "type": "number",
            "enum": [0],
            "description": "Status code for successful operations"
          },
          "result": {
            "type": "object",
            "description": "Result payload for the operation"
          }
        },
        "required": ["status", "result"]
      },
      "ErrorResponse": {
        "type": "object",
        "properties": {
          "status": {
            "type": "number",
            "enum": [1],
            "description": "Status code for error operations"
          },
          "error": {
            "type": "object",
            "description": "Error details"
          }
        },
        "required": ["status", "error"]
      },
      "CommonError": {
        "type": "object",
        "properties": {
          "code": {
            "type": "number",
            "description": "Error code"
          },
          "message": {
            "type": "string",
            "description": "Error message"
          },
          "data": {
            "type": "object",
            "description": "Additional error data",
            "nullable": true
          }
        },
        "required": ["code"]
      },
      "TaskError": {
        "oneOf": [
          {
            "type": "object",
            "properties": {
              "code": {
                "type": "number",
                "enum": [600],
                "description": "CONFIG_FILE_ALREADY_EXISTS error code"
              },
              "message": {
                "type": "string",
                "description": "Error message"
              }
            },
            "required": ["code", "message"]
          },
          {
            "type": "object",
            "properties": {
              "code": {
                "type": "number",
                "enum": [601],
                "description": "TASK_NOT_FOUND error code"
              },
              "message": {
                "type": "string",
                "description": "Error message"
              }
            },
            "required": ["code", "message"]
          },
          {
            "type": "object",
            "properties": {
              "code": {
                "type": "number",
                "enum": [602],
                "description": "COMMAND_ALREADY_CONFIGURED error code"
              },
              "message": {
                "type": "string",
                "description": "Error message"
              }
            },
            "required": ["code", "message"]
          },
          {
            "$ref": "#/components/schemas/CommonError"
          }
        ],
        "discriminator": {
          "propertyName": "code"
        }
      },
      "TaskDefinitionDTO": {
        "type": "object",
        "properties": {
          "name": {
            "type": "string",
            "description": "Name of the task"
          },
          "command": {
            "type": "string",
            "description": "Command to run for the task"
          },
          "runAtStart": {
            "type": "boolean",
            "description": "Whether the task should run when the sandbox starts",
            "nullable": true
          },
          "preview": {
            "type": "object",
            "properties": {
              "port": {
                "type": "number",
                "description": "Port to preview from this task",
                "nullable": true
              },
              "pr-link": {
                "type": "string",
                "enum": ["direct", "redirect", "devtool"],
                "description": "Type of PR link to use",
                "nullable": true
              }
            },
            "nullable": true
          }
        },
        "required": ["name", "command"]
      },
      "CommandShellDTO": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string",
            "description": "ID of the shell command"
          },
          "command": {
            "type": "string",
            "description": "Command being executed"
          },
          "status": {
            "type": "string",
            "enum": ["initializing", "running", "stopped", "error"],
            "description": "Current status of the shell command"
          },
          "output": {
            "type": "string",
            "description": "Current output of the command"
          }
        },
        "required": ["id", "command", "status", "output"]
      },
      "Port": {
        "type": "object",
        "properties": {
          "port": {
            "type": "number",
            "description": "Port number"
          },
          "hostname": {
            "type": "string",
            "description": "Hostname the port is bound to"
          },
          "status": {
            "type": "string",
            "enum": ["open", "closed"],
            "description": "Current status of the port"
          },
          "taskId": {
            "type": "string",
            "description": "ID of the task that opened this port",
            "nullable": true
          }
        },
        "required": ["port", "hostname", "status"]
      },
      "TaskDTO": {
        "allOf": [
          {
            "$ref": "#/components/schemas/TaskDefinitionDTO"
          },
          {
            "type": "object",
            "properties": {
              "id": {
                "type": "string",
                "description": "Unique ID of the task"
              },
              "unconfigured": {
                "type": "boolean",
                "description": "Whether this task is unconfigured (not saved in config)",
                "nullable": true
              },
              "shell": {
                "type": "object",
                "nullable": true,
                "allOf": [
                  {
                    "$ref": "#/components/schemas/CommandShellDTO"
                  }
                ]
              },
              "ports": {
                "type": "array",
                "items": {
                  "$ref": "#/components/schemas/Port"
                },
                "description": "Ports opened by this task"
              }
            },
            "required": ["id", "shell", "ports"]
          }
        ]
      },
      "TaskListDTO": {
        "type": "object",
        "properties": {
          "tasks": {
            "type": "object",
            "additionalProperties": {
              "$ref": "#/components/schemas/TaskDTO"
            },
            "description": "Map of task IDs to task objects"
          },
          "setupTasks": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/TaskDefinitionDTO"
            },
            "description": "Tasks that run during sandbox setup"
          },
          "validationErrors": {
            "type": "array",
            "items": {
              "type": "string"
            },
            "description": "Validation errors in the task configuration"
          }
        },
        "required": ["tasks", "setupTasks", "validationErrors"]
      }
    }
  }
}
